# Manually trigger this workflow to backfill all existing issues and PRs to the project board
# Use this once after setting up the automation, or if items were created before automation was enabled

name: Backfill Project Board

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (show what would be added without actually adding)'
        required: false
        default: 'false'
        type: boolean

env:
  PROJECT_URL: https://github.com/orgs/Gater-Robot/projects/1
  REPO: Gater-Robot/gater-robot

jobs:
  backfill-issues:
    name: Backfill issues
    runs-on: ubuntu-latest
    steps:
      - name: Get all open issues
        id: issues
        env:
          GH_TOKEN: ${{ secrets.PROJECT_TOKEN }}
        run: |
          echo "Fetching all open issues..."
          gh issue list --repo $REPO --state open --limit 500 --json number,title | jq -r '.[] | "\(.number) - \(.title)"'

      - name: Add open issues to project
        if: ${{ inputs.dry_run != true }}
        env:
          GH_TOKEN: ${{ secrets.PROJECT_TOKEN }}
        run: |
          echo "Adding open issues to project..."
          for issue_number in $(gh issue list --repo $REPO --state open --limit 500 --json number --jq '.[].number'); do
            echo "Adding issue #$issue_number..."
            gh project item-add 1 --owner Gater-Robot --url "https://github.com/$REPO/issues/$issue_number" || echo "  (may already exist)"
            sleep 0.5  # Rate limiting
          done

  backfill-prs:
    name: Backfill PRs
    runs-on: ubuntu-latest
    steps:
      - name: Get all open PRs
        id: prs
        env:
          GH_TOKEN: ${{ secrets.PROJECT_TOKEN }}
        run: |
          echo "Fetching all open PRs..."
          gh pr list --repo $REPO --state open --limit 500 --json number,title | jq -r '.[] | "\(.number) - \(.title)"'

      - name: Add open PRs to project
        if: ${{ inputs.dry_run != true }}
        env:
          GH_TOKEN: ${{ secrets.PROJECT_TOKEN }}
        run: |
          echo "Adding open PRs to project..."
          for pr_number in $(gh pr list --repo $REPO --state open --limit 500 --json number --jq '.[].number'); do
            echo "Adding PR #$pr_number..."
            gh project item-add 1 --owner Gater-Robot --url "https://github.com/$REPO/pull/$pr_number" || echo "  (may already exist)"
            sleep 0.5  # Rate limiting
          done
