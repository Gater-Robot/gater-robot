#!/usr/bin/env bash
#
# ntfy.sh - CLI wrapper for ntfy.sh push notifications
#
# A simple tool to send push notifications via ntfy.sh API.
# Designed for use with Claude Code and developer workflows.
#
# Usage:
#   ntfy.sh [OPTIONS] "message"
#   echo "message" | ntfy.sh [OPTIONS]
#
# Environment:
#   NTFY_CHANNEL - Required. The ntfy.sh topic/channel name
#   NTFY_SERVER  - Optional. Server URL (default: https://ntfy.sh)
#
# Examples:
#   ntfy.sh "Build complete!"
#   ntfy.sh --title "PR Created" --click "https://github.com/..." "PR #123 ready for review"
#   ntfy.sh --priority high --tags "warning" "Deployment failed"
#

set -euo pipefail

# Model icon URLs (raw GitHub content)
CLAUDE_ICON_URL="https://raw.githubusercontent.com/Gater-Robot/gater-robot/main/.agents/assets/claude-256.png"
CODEX_ICON_URL="https://raw.githubusercontent.com/Gater-Robot/gater-robot/main/.agents/assets/codex-256.png"
GEMINI_ICON_URL="https://raw.githubusercontent.com/Gater-Robot/gater-robot/main/.agents/assets/gemini-256.png"

# Default values
NTFY_SERVER="${NTFY_SERVER:-https://ntfy.sh}"
TITLE=""
PRIORITY=""
TAGS=""
CLICK=""
ACTIONS=""
ATTACH=""
EMAIL=""
DELAY=""
MESSAGE=""
ICON=""

# Color output helpers
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

error() {
    echo -e "${RED}Error:${NC} $1" >&2
    exit 1
}

warn() {
    echo -e "${YELLOW}Warning:${NC} $1" >&2
}

success() {
    echo -e "${GREEN}Success:${NC} $1"
}

usage() {
    cat << 'EOF'
ntfy.sh - CLI wrapper for ntfy.sh push notifications

USAGE:
    ntfy.sh [OPTIONS] "message"
    echo "message" | ntfy.sh [OPTIONS]

OPTIONS:
    -t, --title TITLE       Notification title
    -p, --priority LEVEL    Priority: min|low|default|high|urgent (or 1-5)
    -g, --tags TAGS         Comma-separated tags/emojis (e.g., "warning,skull")
    -c, --click URL         URL to open when notification is clicked
    -a, --actions ACTIONS   Action buttons (see below for format)
    -A, --attach URL        Attach file/image from URL
    -e, --email EMAIL       Also send to email address
    -d, --delay DELAY       Schedule message (e.g., "30min", "tomorrow 10am")
    -i, --icon URL          Custom icon URL (must be public HTTP/HTTPS)
    --claude                Use Claude model icon
    --codex                 Use Codex/OpenAI model icon
    --gemini                Use Gemini model icon
    -s, --server URL        Override server URL (default: https://ntfy.sh)
    -h, --help              Show this help message
    -v, --verbose           Show curl command being executed

ENVIRONMENT:
    NTFY_CHANNEL    Required. The ntfy.sh topic/channel name
    NTFY_SERVER     Optional. Server URL (default: https://ntfy.sh)

PRIORITY LEVELS:
    min/1       Minimum priority (no sound/vibration)
    low/2       Low priority
    default/3   Default priority
    high/4      High priority (louder notification)
    urgent/5    Maximum priority (persistent, loud)

TAGS (EMOJIS):
    Tags that match emoji shortcodes are converted to emojis.
    Common tags: warning, check, x, rocket, tada, fire, bug, wrench

    Example: --tags "rocket,check" displays as: rocket checkmark emojis

ACTIONS FORMAT:
    Simple:  "view, Open Link, https://example.com"
    HTTP:    "http, Call API, https://api.example.com/endpoint, method=POST"

    Multiple actions separated by semicolon:
    "view, Open PR, https://github.com/...; http, Approve, https://api/approve"

EXAMPLES:
    # Simple notification
    ntfy.sh "Build complete!"

    # With title and priority
    ntfy.sh -t "CI Pipeline" -p high "Tests failed on main branch"

    # With clickable link
    ntfy.sh -t "PR Created" -c "https://github.com/owner/repo/pull/123" \
        "PR #123 is ready for review"

    # With emoji tags
    ntfy.sh -t "Deploy" -g "rocket,white_check_mark" "Production deploy successful"

    # With action button
    ntfy.sh -t "Approval Needed" \
        -a "view, Review PR, https://github.com/owner/repo/pull/123" \
        "PR requires your review"

    # Scheduled notification
    ntfy.sh -d "30min" "Reminder: Check CI status"

    # Pipe message from stdin
    echo "Long message here" | ntfy.sh -t "Build Log"

    # With model icons (for AI agents to sign notifications)
    ntfy.sh --claude -t "Task Complete" "Claude finished the build"
    ntfy.sh --codex -t "Code Review" "Codex completed code review"
    ntfy.sh --gemini -t "Analysis Done" "Gemini finished analysis"

    # Custom icon URL
    ntfy.sh -i "https://example.com/icon.png" -t "Custom" "With custom icon"

EOF
    exit 0
}

# Parse command line arguments
parse_args() {
    local VERBOSE=0

    while [[ $# -gt 0 ]]; do
        case "$1" in
            -t|--title)
                TITLE="$2"
                shift 2
                ;;
            -p|--priority)
                PRIORITY="$2"
                shift 2
                ;;
            -g|--tags)
                TAGS="$2"
                shift 2
                ;;
            -c|--click)
                CLICK="$2"
                shift 2
                ;;
            -a|--actions)
                ACTIONS="$2"
                shift 2
                ;;
            -A|--attach)
                ATTACH="$2"
                shift 2
                ;;
            -e|--email)
                EMAIL="$2"
                shift 2
                ;;
            -d|--delay)
                DELAY="$2"
                shift 2
                ;;
            -i|--icon)
                ICON="$2"
                shift 2
                ;;
            --claude)
                ICON="$CLAUDE_ICON_URL"
                shift
                ;;
            --codex)
                ICON="$CODEX_ICON_URL"
                shift
                ;;
            --gemini)
                ICON="$GEMINI_ICON_URL"
                shift
                ;;
            -s|--server)
                NTFY_SERVER="$2"
                shift 2
                ;;
            -h|--help)
                usage
                ;;
            -v|--verbose)
                VERBOSE=1
                shift
                ;;
            -*)
                error "Unknown option: $1. Use --help for usage."
                ;;
            *)
                MESSAGE="$1"
                shift
                ;;
        esac
    done

    export VERBOSE
}

# Validate inputs
validate() {
    # Check for channel
    if [[ -z "${NTFY_CHANNEL:-}" ]]; then
        error "NTFY_CHANNEL environment variable is not set.

Set it with:
    export NTFY_CHANNEL=your-channel-name

Or for a single command:
    NTFY_CHANNEL=your-channel-name ntfy.sh \"message\""
    fi

    # Read from stdin if no message provided
    if [[ -z "$MESSAGE" ]]; then
        if [[ -t 0 ]]; then
            # No stdin and no message argument
            error "No message provided. Use --help for usage."
        else
            MESSAGE=$(cat)
        fi
    fi

    # Validate priority if provided
    if [[ -n "$PRIORITY" ]]; then
        case "$PRIORITY" in
            min|1|low|2|default|3|high|4|urgent|max|5) ;;
            *) error "Invalid priority: $PRIORITY. Use: min, low, default, high, urgent (or 1-5)" ;;
        esac
    fi
}

# Build and execute curl command
send_notification() {
    local URL="${NTFY_SERVER}/${NTFY_CHANNEL}"
    local CURL_ARGS=(-s -S -X POST)

    # Add headers
    if [[ -n "$TITLE" ]]; then
        CURL_ARGS+=(-H "Title: $TITLE")
    fi

    if [[ -n "$PRIORITY" ]]; then
        CURL_ARGS+=(-H "Priority: $PRIORITY")
    fi

    if [[ -n "$TAGS" ]]; then
        CURL_ARGS+=(-H "Tags: $TAGS")
    fi

    if [[ -n "$CLICK" ]]; then
        CURL_ARGS+=(-H "Click: $CLICK")
    fi

    if [[ -n "$ACTIONS" ]]; then
        CURL_ARGS+=(-H "Actions: $ACTIONS")
    fi

    if [[ -n "$ATTACH" ]]; then
        CURL_ARGS+=(-H "Attach: $ATTACH")
    fi

    if [[ -n "$EMAIL" ]]; then
        CURL_ARGS+=(-H "Email: $EMAIL")
    fi

    if [[ -n "$DELAY" ]]; then
        CURL_ARGS+=(-H "Delay: $DELAY")
    fi

    if [[ -n "$ICON" ]]; then
        CURL_ARGS+=(-H "Icon: $ICON")
    fi

    # Add message body
    CURL_ARGS+=(-d "$MESSAGE")

    # Add URL
    CURL_ARGS+=("$URL")

    # Show command if verbose
    if [[ "${VERBOSE:-0}" == "1" ]]; then
        echo "curl ${CURL_ARGS[*]}" >&2
    fi

    # Execute curl
    local RESPONSE
    local HTTP_CODE

    # Get both response body and HTTP code
    RESPONSE=$(curl -w "\n%{http_code}" "${CURL_ARGS[@]}" 2>&1) || {
        error "curl failed: $RESPONSE"
    }

    # Extract HTTP code (last line) and body (everything else)
    HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
    RESPONSE=$(echo "$RESPONSE" | sed '$d')

    # Check HTTP status
    if [[ "$HTTP_CODE" -ge 200 && "$HTTP_CODE" -lt 300 ]]; then
        success "Notification sent to ${NTFY_CHANNEL}"
        if [[ "${VERBOSE:-0}" == "1" ]]; then
            echo "Response: $RESPONSE"
        fi
    else
        error "Failed to send notification (HTTP $HTTP_CODE): $RESPONSE"
    fi
}

# Main execution
main() {
    parse_args "$@"
    validate
    send_notification
}

main "$@"
